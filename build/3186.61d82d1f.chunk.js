"use strict";(self.webpackChunknassif_group_strapi=self.webpackChunknassif_group_strapi||[]).push([[3186],{43186:(Es,A,s)=>{s.r(A),s.d(A,{default:()=>b});var t=s(92132),E=s(56445),d=s(82437),k=s(97927),g=s(21272),F=s(85963),N=s(43064),m=s(83997),R=s(30893),V=s(54514),v=s(61535),z=s(48940),Y=s(54894),$=s(74930),H=s(17703),Q=s(12038),G=s(23302),o=s(48106),J=s(89031),c=s(76523),M=s(63072),a=s(80909),X=s(25844),ds=s(55151),gs=s(79077),Ms=s(59057),fs=s(15126),cs=s(63299),Ds=s(67014),Os=s(59080),Ps=s(79275),ms=s(14718),vs=s(5790),hs=s(12083),us=s(41286),Ls=s(35223),Cs=s(5409),Ts=s(2600),ws=s(51187),As=s(86781),Rs=s(84624),Ws=s(77965),Is=s(54257),Bs=s(71210),ys=s(57505),Ks=s(40145),Us=s(56336),js=s(75866);function Z(){const{formatMessage:n}=(0,Y.A)(),{post:q}=(0,E.ry)(),{push:ss}=(0,H.W6)(),{formatAPIError:ts}=(0,E.wq)(),_=(0,d.wA)(),D=(0,E.hN)(),{collectionTypes:W,singleTypes:I,isLoading:h}=(0,G.u)(),{isLoading:O,meta:u,workflows:L}=(0,X.u)(),{isLoading:C,roles:B}=(0,Q.u)(void 0,{retry:!1}),P=(0,d.d4)(o.s),es=(0,d.d4)(o.a),l=(0,d.d4)(o.b),y=(0,d.d4)(o.c),[K,f]=g.useState(!1),{isLoading:U,getFeature:os}=(0,J.u)(),[ns,as]=g.useState(null),[j,T]=g.useState({}),i=os("review-workflows"),p=L.flatMap(e=>e.contentTypes),{mutateAsync:is,isLoading:ls}=(0,$.useMutation)(async({workflow:e})=>{const{data:{data:r}}=await q("/admin/review-workflows/workflows",{data:e});return r},{onSuccess(){D({type:"success",message:{id:"Settings.review-workflows.create.page.notification.success",defaultMessage:"Workflow successfully created"}})}}),x=async()=>{T({});try{const e=await is({workflow:l});return ss(`/settings/review-workflows/${e.id}`),e}catch(e){return e.response.data?.error?.name==="ValidationError"&&e.response.data?.error?.details?.errors?.length>0&&as(e.response.data?.error?.details?.errors.reduce((r,S)=>(z(r,S.path,S.message),r),{})),D({type:"warning",message:ts(e)}),null}},rs=async()=>{await x()},_s=()=>{T({})},w=(0,v.Wx)({enableReinitialize:!0,initialErrors:ns,initialValues:l,async onSubmit(){const e=l.contentTypes.some(r=>p.includes(r));i?.[a.C]&&u?.workflowCount>=parseInt(i[a.C],10)?f("workflow"):i?.[a.a]&&l.stages.length>=parseInt(i[a.a],10)?f("stage"):e?T(r=>({...r,hasReassignedContentTypes:!0})):x()},validate(e){return(0,o.v)({values:e,formatMessage:n})}});return(0,o.u)(a.R,o.i),g.useEffect(()=>{_((0,o.r)()),O||_((0,o.d)({workflows:L})),h||_((0,o.e)({collectionTypes:W,singleTypes:I})),C||_((0,o.f)(B)),_((0,o.g)(h||C)),_((0,o.h)({name:""}))},[W,_,h,C,O,B,I,L]),g.useEffect(()=>{!O&&!U&&(i?.[a.C]&&u?.workflowsTotal>=parseInt(i[a.C],10)?f("workflow"):i?.[a.a]&&l.stages.length>=parseInt(i[a.a],10)&&f("stage"))},[U,O,i,u?.workflowsTotal,l.stages.length]),g.useEffect(()=>{!P&&y.length===0&&D({blockTransition:!0,type:"warning",message:n({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[n,P,y,D]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.D,{}),(0,t.jsx)(v.QI,{value:w,children:(0,t.jsxs)(v.lV,{onSubmit:w.handleSubmit,children:[(0,t.jsx)(c.H,{navigationAction:(0,t.jsx)(c.B,{href:"/settings/review-workflows"}),primaryAction:(0,t.jsx)(F.$,{startIcon:(0,t.jsx)(V.A,{}),type:"submit",size:"M",disabled:!es,isLoading:ls,children:n({id:"global.save",defaultMessage:"Save"})}),title:n({id:"Settings.review-workflows.create.page.title",defaultMessage:"Create Review Workflow"}),subtitle:n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:l?.stages?.length??0})}),(0,t.jsx)(c.R,{children:(0,t.jsx)(m.s,{alignItems:"stretch",direction:"column",gap:7,children:P?(0,t.jsx)(N.a,{children:n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})}):(0,t.jsxs)(m.s,{alignItems:"stretch",direction:"column",gap:7,children:[(0,t.jsx)(o.W,{}),(0,t.jsx)(o.S,{stages:w.values?.stages})]})})})]})}),(0,t.jsx)(E.TM.Root,{isConfirmButtonLoading:P,isOpen:Object.keys(j).length>0,onToggleDialog:_s,onConfirm:rs,children:(0,t.jsx)(E.TM.Body,{children:(0,t.jsxs)(m.s,{direction:"column",gap:5,children:[j.hasReassignedContentTypes&&(0,t.jsx)(R.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:p.filter(e=>l.contentTypes.includes(e)).length})}),(0,t.jsx)(R.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,t.jsxs)(M.L,{isOpen:K==="workflow",onClose:()=>f(!1),children:[(0,t.jsx)(M.T,{children:n({id:"Settings.review-workflows.create.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,t.jsx)(M.B,{children:n({id:"Settings.review-workflows.create.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,t.jsxs)(M.L,{isOpen:K==="stage",onClose:()=>f(!1),children:[(0,t.jsx)(M.T,{children:n({id:"Settings.review-workflows.create.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,t.jsx)(M.B,{children:n({id:"Settings.review-workflows.create.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}function b(){const n=(0,d.d4)(k.s);return(0,t.jsx)(E.kz,{permissions:n.settings["review-workflows"].create,children:(0,t.jsx)(Z,{})})}}}]);
