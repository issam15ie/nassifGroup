"use strict";(self.webpackChunknassif_group_strapi=self.webpackChunknassif_group_strapi||[]).push([[2222],{72222:(us,K,s)=>{s.r(K),s.d(K,{default:()=>is});var e=s(92132),E=s(56445),i=s(82437),j=s(97927),f=s(21272),G=s(85963),J=s(43064),T=s(83997),A=s(30893),X=s(54514),I=s(61535),Z=s(48940),b=s(54894),q=s(74930),ss=s(17703),es=s(12038),ts=s(23302),o=s(48106),os=s(89031),v=s(76523),M=s(63072),l=s(80909),ns=s(25844),ws=s(55151),Cs=s(79077),Ls=s(59057),Ts=s(15126),As=s(63299),Is=s(67014),Rs=s(59080),Ws=s(79275),ys=s(14718),ps=s(5790),Bs=s(12083),Us=s(41286),Ks=s(35223),js=s(5409),xs=s(2600),Ss=s(51187),ks=s(86781),Fs=s(84624),Ns=s(77965),Vs=s(54257),zs=s(71210),Ys=s(57505),$s=s(40145),Hs=s(56336),Qs=s(75866);function as(){const{workflowId:P}=(0,ss.g)(),ls=(0,i.d4)(j.s),{formatMessage:n}=(0,b.A)(),g=(0,i.wA)(),{put:rs}=(0,E.ry)(),{formatAPIError:ds}=(0,E.wq)(),h=(0,E.hN)(),{isLoading:D,meta:u,workflows:w,refetch:_s}=(0,ns.u)(),{collectionTypes:x,singleTypes:S,isLoading:R}=(0,ts.u)(),Es=(0,i.d4)(o.j),gs=(0,i.d4)(o.a),r=(0,i.d4)(o.b),k=(0,i.d4)(o.k),F=(0,i.d4)(o.c),m=(0,i.d4)(o.s),{allowedActions:{canDelete:fs,canUpdate:W}}=(0,E.ec)(ls.settings["review-workflows"]),[C,L]=f.useState({}),{getFeature:Ms,isLoading:N}=(0,os.u)(),{isLoading:y,roles:V}=(0,es.u)(void 0,{retry:!1}),[z,c]=f.useState(!1),[cs,Y]=f.useState(null),$=w.find(t=>t.id===parseInt(P,10)),H=w.filter(t=>t.id!==parseInt(P,10)).flatMap(t=>t.contentTypes),{mutateAsync:Ds,isLoading:ms}=(0,q.useMutation)(async({workflow:t})=>{const{data:{data:a}}=await rs(`/admin/review-workflows/workflows/${t.id}`,{data:t});return a},{onSuccess(){h({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),Os=async t=>{Y(null);try{return await Ds({workflow:{...t,stages:t.stages.map(_=>{let O=!0;const B=Es.workflow.stages.find(U=>U.id===_?.id);return B&&(O=B.permissions?.length!==_.permission?.length||!B.permissions.every(U=>!!_.permissions.find(hs=>hs.role===U.role))),{..._,permissions:O?_.permissions:void 0}})}})}catch(a){return a.response.data?.error?.name==="ValidationError"&&a.response.data?.error?.details?.errors?.length>0&&Y(a.response.data?.error?.details?.errors.reduce((_,O)=>(Z(_,O.path,O.message),_),{})),h({type:"warning",message:ds(a)}),null}},Q=async()=>{await Os(r),await _s(),L({})},vs=async()=>{await Q()},Ps=()=>{L({})},p=(0,I.Wx)({enableReinitialize:!0,initialErrors:cs,initialValues:r,async onSubmit(){const t=r.contentTypes.some(a=>H.includes(a));d?.[l.C]&&u?.workflowCount>parseInt(d[l.C],10)?c("workflow"):d?.[l.a]&&r.stages.length>parseInt(d[l.a],10)?c("stage"):k||t?(k&&L(a=>({...a,hasDeletedServerStages:!0})),t&&L(a=>({...a,hasReassignedContentTypes:!0}))):Q()},validate(t){return(0,o.v)({values:t,formatMessage:n})}});(0,o.u)(l.R,o.i);const d=Ms("review-workflows");return f.useEffect(()=>(D||(g((0,o.l)({workflow:$})),g((0,o.d)({workflows:w}))),R||g((0,o.e)({collectionTypes:x,singleTypes:S})),y||g((0,o.f)(V)),g((0,o.g)(D||R||y)),()=>{g((0,o.r)())}),[x,g,R,D,y,V,S,$,w]),f.useEffect(()=>{!D&&!N&&(d?.[l.C]&&u?.workflowCount>parseInt(d[l.C],10)?c("workflow"):d?.[l.a]&&r.stages.length>parseInt(d[l.a],10)&&c("stage"))},[r.stages.length,N,D,d,u?.workflowCount,u.workflowsTotal]),f.useEffect(()=>{!m&&F.length===0&&h({blockTransition:!0,type:"warning",message:n({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[n,m,F,h]),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(v.D,{}),(0,e.jsx)(I.QI,{value:p,children:(0,e.jsxs)(I.lV,{onSubmit:p.handleSubmit,children:[(0,e.jsx)(v.H,{navigationAction:(0,e.jsx)(v.B,{href:"/settings/review-workflows"}),primaryAction:W&&(0,e.jsx)(G.$,{startIcon:(0,e.jsx)(X.A,{}),type:"submit",size:"M",disabled:!gs,loading:!Object.keys(C).length>0&&ms,children:n({id:"global.save",defaultMessage:"Save"})}),subtitle:!m&&n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:r.stages.length}),title:r.name}),(0,e.jsx)(v.R,{children:m?(0,e.jsx)(T.s,{justifyContent:"center",children:(0,e.jsx)(J.a,{children:n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})})}):(0,e.jsxs)(T.s,{alignItems:"stretch",direction:"column",gap:7,children:[(0,e.jsx)(o.W,{canUpdate:W}),(0,e.jsx)(o.S,{canDelete:fs,canUpdate:W,stages:p.values?.stages})]})})]})}),(0,e.jsx)(E.TM.Root,{isConfirmButtonLoading:m,isOpen:Object.keys(C).length>0,onToggleDialog:Ps,onConfirm:vs,children:(0,e.jsx)(E.TM.Body,{children:(0,e.jsxs)(T.s,{direction:"column",gap:5,children:[C.hasDeletedServerStages&&(0,e.jsx)(A.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})}),C.hasReassignedContentTypes&&(0,e.jsx)(A.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:H.filter(t=>r.contentTypes.includes(t)).length})}),(0,e.jsx)(A.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,e.jsxs)(M.L,{isOpen:z==="workflow",onClose:()=>c(!1),children:[(0,e.jsx)(M.T,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,e.jsx)(M.B,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,e.jsxs)(M.L,{isOpen:z==="stage",onClose:()=>c(!1),children:[(0,e.jsx)(M.T,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,e.jsx)(M.B,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}function is(){const P=(0,i.d4)(j.s);return(0,e.jsx)(E.kz,{permissions:P.settings["review-workflows"].main,children:(0,e.jsx)(as,{})})}}}]);
